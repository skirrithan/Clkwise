<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CLKWISE - ENHANCED AI ANALYSIS RESULTS</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap');
        
        :root {
            --primary-bg: #000000;
            --secondary-bg: #111111;
            --tertiary-bg: #333333;
            --text-primary: #ffffff;
            --text-secondary: #737373;
            --accent-yellow: #FFD700;
            --accent-blue: #0057B8;
            --accent-green: #999999;
            --accent-red: #DC3545;
            --accent-success: #28a745;
            --border-color: #333333;
            --hover-bg: rgba(255, 255, 255, 0.07);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            outline: none !important;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        ::selection {
            background-color: var(--accent-yellow);
            color: #000;
        }
        
        ::-moz-selection {
            background-color: var(--accent-yellow);
            color: #000;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--primary-bg);
            min-height: 100vh;
            color: var(--text-primary);
            line-height: 1.5;
            font-size: 20px;
            margin: 0 auto;
        }
        
        @media (max-width: 1279.98px) {
            body {
                font-size: 14px;
            }
        }
        
        .page-wrapper {
            min-height: 100vh;
            background: var(--primary-bg);
            max-width: 1600px;
            margin: 0 auto;
        }
        
        .nav-bar {
            background: var(--primary-bg);
            border-bottom: 1px solid var(--border-color);
            padding: 20px 0;
            position: sticky;
            top: 0;
            z-index: 50;
        }
        
        @media (max-width: 639.98px) {
            .nav-bar {
                padding: 15px 0;
            }
        }
        
        .nav-content {
            max-width: 1600px;
            margin: 0 auto;
            padding: 0 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        @media (max-width: 639.98px) {
            .nav-content {
                padding: 0 15px;
            }
        }
        
        .logo {
            font-size: 32px;
            font-weight: 800;
            color: var(--text-primary);
            text-decoration: none;
            letter-spacing: -0.02em;
            text-transform: uppercase;
        }
        
        @media (max-width: 639.98px) {
            .logo {
                font-size: 24px;
            }
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 0 25px;
        }
        
        @media (max-width: 639.98px) {
            .container {
                padding: 0 15px;
            }
        }
        
        .hero-section {
            padding: 80px 0 60px;
            text-align: center;
            border-bottom: 1px solid var(--border-color);
            background: var(--primary-bg);
        }
        
        @media (max-width: 639.98px) {
            .hero-section {
                padding: 40px 0 30px;
            }
        }
        
        .hero-title {
            font-size: 24px;
            font-weight: 800;
            color: var(--text-primary);
            margin-bottom: 25px;
            letter-spacing: -0.02em;
            line-height: 1.12;
            text-transform: uppercase;
            font-family: 'Inter', sans-serif;
        }
        
        @media (max-width: 639.98px) {
            .hero-title {
                font-size: 18px;
                margin-bottom: 14px;
                line-height: 1.13;
            }
        }
        
        .hero-subtitle {
            font-size: 14px;
            color: var(--text-secondary);
            font-weight: 400;
            text-transform: uppercase;
            letter-spacing: 0.02em;
        }
        
        @media (max-width: 639.98px) {
            .hero-subtitle {
                font-size: 12px;
            }
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 0;
            min-height: 600px;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        /* Loading State */
        .loading {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--border-color);
            border-top: 4px solid var(--accent-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Enhanced Summary Cards */
        .analysis-header {
            background: var(--secondary-bg);
            border: 1px solid var(--border-color);
            padding: 30px;
            margin-bottom: 30px;
            border-radius: 8px;
        }

        .analysis-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 10px;
            text-transform: uppercase;
        }

        .analysis-status {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.02em;
        }

        .analysis-status.critical {
            background: var(--accent-red);
            color: white;
        }

        .analysis-status.moderate {
            background: #FF8C00;
            color: white;
        }

        .analysis-status.minor {
            background: #FFD700;
            color: #000;
        }

        .analysis-status.pass {
            background: var(--accent-success);
            color: white;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .summary-card {
            background: var(--tertiary-bg);
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            border-left: 4px solid var(--accent-blue);
        }

        .summary-card h3 {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.02em;
        }

        .summary-card .value {
            font-size: 24px;
            font-weight: 800;
            color: var(--text-primary);
            margin-bottom: 5px;
        }

        .summary-card .unit {
            font-size: 14px;
            color: var(--text-secondary);
        }

        /* Enhanced Explanation Section */
        .explanation-section {
            background: var(--secondary-bg);
            border: 1px solid var(--border-color);
            margin-bottom: 30px;
            border-radius: 8px;
            overflow: hidden;
        }

        .explanation-header {
            background: var(--tertiary-bg);
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .explanation-header h3 {
            font-size: 16px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.02em;
            margin: 0;
        }

        .sponsor-badges {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 15px;
            align-items: center;
        }

        .sponsor-badge {
            background: linear-gradient(135deg, #1a1a1a 0%, #333333 100%);
            color: var(--text-primary);
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.02em;
            border: 1px solid var(--border-color);
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .sponsor-badge.cohere {
            background: linear-gradient(135deg, #39C5BB 0%, #4DD8CE 100%);
            color: #fff;
        }

        .sponsor-badge.cerebras {
            background: linear-gradient(135deg, #FF1744 0%, #FF5722 100%);
            color: #fff;
        }

        .explanation-content {
            margin-top: 25px;
            padding: 25px;
            background: var(--tertiary-bg);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            line-height: 1.6;
        }

        .quick-facts {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .quick-fact {
            background: var(--tertiary-bg);
            padding: 15px;
            border-radius: 6px;
            font-size: 14px;
        }

        .fix-item {
            background: var(--secondary-bg);
            border: 1px solid var(--border-color);
            margin-bottom: 20px;
            border-radius: 8px;
            overflow: hidden;
        }

        .fix-header {
            background: var(--tertiary-bg);
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .fix-title {
            font-size: 16px;
            font-weight: 700;
            text-transform: uppercase;
        }

        .fix-complexity {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .fix-complexity.low {
            background: var(--accent-success);
            color: white;
        }

        .fix-complexity.medium {
            background: #FF8C00;
            color: white;
        }

        .fix-complexity.high {
            background: var(--accent-red);
            color: white;
        }

        .fix-content {
            padding: 20px;
        }

        .fix-explanation {
            margin-bottom: 20px;
            line-height: 1.6;
        }

        .fix-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .fix-metric {
            background: var(--tertiary-bg);
            padding: 15px;
            border-radius: 6px;
            text-align: center;
        }

        .fix-metric .label {
            font-size: 10px;
            color: var(--text-secondary);
            text-transform: uppercase;
            margin-bottom: 5px;
        }

        .fix-metric .value {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .code-snippet {
            background: #1a1a1a;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 15px;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 12px;
            overflow-x: auto;
            margin-top: 15px;
        }

        .code-snippet pre {
            margin: 0;
            color: #e6e6e6;
        }

        /* Diff highlighting styles */
        .code-diff {
            background: #1a1a1a;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 12px;
            overflow-x: auto;
            margin-top: 15px;
        }

        .diff-line {
            padding: 2px 10px;
            line-height: 1.4;
            white-space: pre;
        }

        .diff-line-added {
            background: rgba(40, 167, 69, 0.2);
            border-left: 4px solid #28a745;
            color: #90ee90;
        }

        .diff-line-removed {
            background: rgba(220, 53, 69, 0.2);
            border-left: 4px solid #dc3545;
            color: #ffb3b3;
        }

        .diff-line-unchanged {
            color: #e6e6e6;
            border-left: 4px solid transparent;
        }

        .diff-header {
            background: var(--tertiary-bg);
            padding: 8px 15px;
            border-bottom: 1px solid var(--border-color);
            font-weight: 600;
            color: var(--text-secondary);
        }

        .diff-line-number {
            color: #666;
            font-size: 10px;
            margin-right: 10px;
            min-width: 30px;
            display: inline-block;
        }

        /* Code Changes Section */
        .code-changes-section {
            background: var(--secondary-bg);
            border: 1px solid var(--border-color);
            margin-bottom: 30px;
            border-radius: 8px;
            overflow: hidden;
        }

        .code-changes-header {
            background: var(--tertiary-bg);
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .code-changes-content {
            padding: 25px;
        }

        .file-modified {
            background: var(--tertiary-bg);
            padding: 10px 15px;
            border-radius: 6px;
            margin-bottom: 15px;
            font-family: monospace;
            border-left: 4px solid var(--accent-blue);
        }

        /* Chat Section */
        .chat-section {
            background: var(--secondary-bg);
            border-left: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            height: 100vh;
            position: sticky;
            top: 0;
        }

        .chat-header {
            padding: 25px;
            border-bottom: 1px solid var(--border-color);
        }

        .chat-header h3 {
            font-size: 18px;
            font-weight: 700;
            text-transform: uppercase;
            margin-bottom: 10px;
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            max-height: calc(100vh - 200px);
        }

        .message {
            margin-bottom: 20px;
            padding: 15px;
            border-radius: 8px;
            line-height: 1.4;
            font-size: 14px;
        }

        .message.user {
            background: var(--tertiary-bg);
            border-left: 4px solid var(--accent-blue);
        }

        .message.ai {
            background: var(--primary-bg);
            border-left: 4px solid var(--accent-green);
        }

        .chat-input {
            padding: 20px;
            border-top: 1px solid var(--border-color);
        }

        .chat-input-box {
            display: flex;
            gap: 10px;
        }

        .chat-input-box input {
            flex: 1;
            padding: 12px;
            background: var(--tertiary-bg);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 14px;
        }

        .chat-send-btn {
            padding: 12px 20px;
            background: var(--accent-blue);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 12px;
        }

        .chat-send-btn:hover {
            background: #0066cc;
        }

        .download-btn:hover {
            background: #218838 !important;
            transform: translateY(-1px);
        }
        
        /* Side-by-side code comparison */
        .code-comparison-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 25px;
        }
        
        @media (max-width: 768px) {
            .code-comparison-container {
                grid-template-columns: 1fr;
                gap: 15px;
            }
        }
        
        .code-panel {
            border: 1px solid var(--border-color);
            border-radius: 0;
            overflow: hidden;
        }
        
        .code-panel-header {
            padding: 15px 25px;
            font-weight: 600;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.02em;
            font-family: 'Inter', sans-serif;
        }
        
        .code-panel-header.original {
            background: rgba(220, 53, 69, 0.1);
            color: #ffb3b3;
            border-bottom: 1px solid #dc3545;
        }
        
        .code-panel-header.optimized {
            background: rgba(40, 167, 69, 0.1);
            color: #90ee90;
            border-bottom: 1px solid #28a745;
        }
        
        .code-panel-content {
            background: #1a1a1a;
            padding: 25px;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 14px;
            color: #e6e6e6;
            overflow-x: auto;
            max-height: 600px;
            overflow-y: auto;
        }
        
        .code-line {
            line-height: 1.4;
            margin-bottom: 2px;
            white-space: pre;
        }
        
        .code-line-number {
            color: #666;
            margin-right: 15px;
            display: inline-block;
            min-width: 30px;
            text-align: right;
        }
        
        .highlight-added {
            background: rgba(40, 167, 69, 0.2);
            color: #90ee90;
        }
        
        .highlight-removed {
            background: rgba(220, 53, 69, 0.2);
            color: #ffb3b3;
        }
    </style>
        /* Footer */
        .footer {
            background: var(--secondary-bg);
            border-top: 1px solid var(--border-color);
            padding: 40px 0;
            margin-top: 80px;
        }

        .footer-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .footer-text {
            font-size: 14px;
            color: var(--text-secondary);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.02em;
        }

        .footer-links {
            display: flex;
            gap: 20px;
        }

        .footer-link {
            color: var(--text-secondary);
            text-decoration: none;
font-size: 10px;
            text-transform: uppercase;
            font-weight: 500;
            transition: color 0.2s ease;
        }

        .footer-link:hover {
            color: var(--text-primary);
        }

        @media (max-width: 639.98px) {
            .footer {
                padding: 25px 0;
                margin-top: 40px;
            }
            
            .footer-content {
                flex-direction: column;
                text-align: center;
            }
            
            .summary-grid {
                grid-template-columns: 1fr;
            }
            
            .quick-facts {
                grid-template-columns: 1fr;
            }
            
            .fix-metrics {
                grid-template-columns: 1fr 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="page-wrapper">
        <nav class="nav-bar">
            <div class="nav-content">
                <a href="/" class="logo">CLKWISE</a>
            </div>
        </nav>
        
        <div class="hero-section">
            <div class="container">
                <h1 class="hero-title">AI-ENHANCED TIMING ANALYSIS</h1>
                <p class="hero-subtitle">CEREBRAS + COHERE DUAL AI PIPELINE ANALYSIS</p>
            </div>
        </div>
        
        <div class="container">
            <div class="main-content">
                <div class="results-section">
                    <!-- Loading State -->
                    <div id="loading" class="loading">
                        <div class="loading-spinner"></div>
                        <p>Loading AI-enhanced timing analysis...</p>
                    </div>

                    <!-- Analysis Content (Hidden initially) -->
                    <div id="analysis-content" style="display: none;">
                        <!-- Code Changes (moved to top) -->
                        <div class="code-changes-section">
                            <div class="code-changes-header">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;">
                                    <h3 style="margin: 0;">GENERATED CODE CHANGES</h3>
                                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
<button onclick="downloadVerilog()" class="download-btn" style="background: #007bff; color: white; border: none; border-radius: 6px; font-size: 10px; font-weight: 600; padding: 10px 16px; cursor: pointer; text-transform: uppercase; transition: background 0.2s ease; font-family: inherit;">💾 DOWNLOAD VERILOG</button>
<button onclick="downloadJSON()" class="download-btn" style="background: #28a745; color: white; border: none; border-radius: 6px; font-size: 10px; font-weight: 600; padding: 10px 16px; cursor: pointer; text-transform: uppercase; transition: background 0.2s ease; font-family: inherit;">📥 DOWNLOAD JSON</button>
                                    </div>
                                </div>
                            </div>
                            <div class="code-changes-content" id="code-changes-content">
                                <!-- Code changes will be populated by JavaScript -->
                            </div>
                        </div>

                        <!-- Analysis Header -->
                        <div class="analysis-header">
                            <div class="analysis-title" id="analysis-title">Loading...</div>
                            <div class="analysis-status" id="analysis-status">Unknown</div>
                            
                            <div class="summary-grid">
                                <div class="summary-card">
                                    <h3>WORST NEGATIVE SLACK</h3>
                                    <div class="value" id="wns-value">Loading...</div>
                                    <div class="unit">nanoseconds</div>
                                </div>
                                <div class="summary-card">
                                    <h3>CLOCK FREQUENCY</h3>
                                    <div class="value" id="frequency-value">Loading...</div>
                                    <div class="unit">MHz</div>
                                </div>
                                <div class="summary-card">
                                    <h3>TOTAL FIXES</h3>
                                    <div class="value" id="fixes-count">Loading...</div>
                                    <div class="unit">suggested</div>
                                </div>
                                <div class="summary-card">
                                    <h3>LATENCY IMPACT</h3>
                                    <div class="value" id="latency-impact">Loading...</div>
                                    <div class="unit">cycles</div>
                                </div>
                            </div>
                            
                            <!-- AI Analysis Content -->
                            <div class="explanation-content">
                                <div id="explanation-text">Loading detailed analysis...</div>
                                <div class="quick-facts" id="quick-facts">
                                    <!-- Quick facts will be populated by JavaScript -->
                                </div>
                            </div>
                        </div>

                        <a href="/" class="chat-send-btn" style="display: inline-block; text-decoration: none; margin-top: 20px;">ANALYZE NEW DESIGN</a>
                    </div>
                </div>

                <div class="chat-section">
                    <div class="chat-header">
                        <h3>AI TIMING EXPERT</h3>
                        <p>ASK ABOUT THE ANALYSIS, FIXES, OR FPGA TIMING OPTIMIZATION</p>
                        <div class="sponsor-badges">
                            <span class="sponsor-badge cohere">🧠 COHERE CHAT</span>
                        </div>
                    </div>
                    <div class="chat-messages" id="chatMessages">
                        <div class="message ai">
                            <strong>AI Expert:</strong> AI analysis complete! I can explain the timing violations, discuss fix implementations, or answer questions about FPGA timing optimization.
                        </div>
                    </div>
                    <div class="chat-input">
                        <div class="chat-input-box">
                            <input type="text" id="chatInput" placeholder="Ask about violations, fixes, or optimization strategies..." 
                                   onkeypress="if(event.key==='Enter') sendMessage()">
                            <button class="chat-send-btn" onclick="sendMessage()">SEND</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Footer -->
        <footer class="footer">
            <div class="container">
                <div class="footer-content">
                    <div class="footer-text">CLKWISE AI FPGA TIMING ANALYSIS PLATFORM</div>
                    <div class="footer-links">
                        <a href="/about" class="footer-link">About</a>
                        <a href="#" class="footer-link">Documentation</a>
                        <a href="#" class="footer-link">Support</a>
                        <a href="#" class="footer-link">Contact</a>
                    </div>
                </div>
            </div>
        </footer>
    </div>

    <script>
        let analysisData = null;

        // Load analysis data when page loads
        document.addEventListener('DOMContentLoaded', function() {
            loadAnalysisData();
        });

        async function loadAnalysisData() {
            try {
                // Load summary data
                const summaryResponse = await fetch('/api/analysis/summary');
                const summaryData = await summaryResponse.json();
                
                if (summaryData.status === 'success') {
                    populateSummary(summaryData.summary);
                }

                // Fixes section removed - no longer loading fix data

                // Load code changes
                const codeResponse = await fetch('/api/analysis/code');
                const codeData = await codeResponse.json();
                
                if (codeData.status === 'success') {
                    populateCodeChanges(codeData.code_changes, codeData.artifacts);
                }

                // Hide loading and show content
                document.getElementById('loading').style.display = 'none';
                document.getElementById('analysis-content').style.display = 'block';

            } catch (error) {
                console.error('Error loading analysis data:', error);
                document.getElementById('loading').innerHTML = '<p>Error loading analysis data. Please try refreshing the page.</p>';
            }
        }

        function populateSummary(summary) {
            // Update header
            document.getElementById('analysis-title').textContent = summary.header?.title || 'Timing Analysis';
            
            // Update status
            const statusElement = document.getElementById('analysis-status');
            statusElement.textContent = (summary.severity || 'unknown').toUpperCase();
            statusElement.className = `analysis-status ${summary.severity || 'unknown'}`;

            // Update metrics
            document.getElementById('wns-value').textContent = summary.header?.wns ? summary.header.wns.toFixed(3) : 'N/A';
            document.getElementById('frequency-value').textContent = summary.header?.frequency || 'N/A';
            document.getElementById('fixes-count').textContent = summary.fix_count || 0;
            document.getElementById('latency-impact').textContent = summary.metrics?.total_latency || 0;

            // Update explanation
            document.getElementById('explanation-text').textContent = summary.explanation || 'No detailed explanation available.';

            // Update quick facts
            const quickFactsContainer = document.getElementById('quick-facts');
            quickFactsContainer.innerHTML = '';
            
            if (summary.quick_facts && summary.quick_facts.length > 0) {
                summary.quick_facts.forEach(fact => {
                    const factDiv = document.createElement('div');
                    factDiv.className = 'quick-fact';
                    factDiv.textContent = fact;
                    quickFactsContainer.appendChild(factDiv);
                });
            }
        }

        // populateFixes function removed - fixes section no longer exists

        function populateCodeChanges(codeChanges, artifacts) {
            const container = document.getElementById('code-changes-content');
            
            if (!codeChanges || codeChanges.files_modified?.length === 0) {
                container.innerHTML = '<p>No code changes generated.</p>';
                return;
            }

            let html = '';
            
            // Show modified files
            if (codeChanges.files_modified && codeChanges.files_modified.length > 0) {
                html += '<h4>Modified Files:</h4>';
                codeChanges.files_modified.forEach(file => {
                    html += `<div class="file-modified">${file}</div>`;
                });
            }

            // Show diff if available
            if (codeChanges.diff) {
                html += '<h4>Code Changes (Side-by-Side Comparison):</h4>';
                html += createSideBySideView(codeChanges.diff, artifacts);
            }

            // Show change summary
            if (codeChanges.changes_summary) {
                const summary = codeChanges.changes_summary;
                html += '<div style="background: var(--tertiary-bg); padding: 15px; border-radius: 6px; margin-top: 20px;">';
                html += '<div style="font-size: 14px; font-weight: 600; margin-bottom: 10px; color: var(--text-primary);">Change Summary</div>';
                html += `<p><strong>Original:</strong> ${summary.original_lines} lines | <strong>New:</strong> ${summary.new_lines} lines | <strong>Added:</strong> +${summary.lines_added} lines</p>`;
                html += '</div>';
            }

            // Show full content if available  
            if (artifacts?.top_sv?.ui?.text) {
                html += '<h4>Complete Generated File (top.sv):</h4>';
                html += `<div class="code-snippet" style="max-height: 400px; overflow-y: auto;"><pre>${escapeHtml(artifacts.top_sv.ui.text)}</pre></div>`;
            }

            container.innerHTML = html || '<p>No code changes available.</p>';
        }

        function createSideBySideView(diffText, artifacts) {
            const originalCode = `module top(
  input  logic         clk,
  input  logic         rst_n,
  input  logic [31:0]  a, b, c, d, e, //32 bit
  output logic [63:0]  y //64 bit
);

  logic [63:0] mul1 = a * b; //32 bit x 32 bit
  logic [63:0] mul2 = c * d; //32 bit x 32 bit
  logic [63:0] sum  = mul1 + mul2 + e;  //64 bit + 64 bit + 32 bit

  always_ff @(posedge clk or negedge rst_n) begin
    if (!rst_n) y <= '0;
    else        y <= sum;
  end
endmodule`;
            
            const optimizedCode = artifacts?.top_sv?.content || '';
            
            let html = '<div class="code-comparison-container">';
            
            // Original code panel
            html += '<div class="code-panel">';
            html += '<div class="code-panel-header original">❌ Original Code (With Timing Violations)</div>';
            html += '<div class="code-panel-content">';
            
            const originalLines = originalCode.split('\n');
            originalLines.forEach((line, index) => {
                const lineNum = (index + 1).toString().padStart(2, ' ');
                let cssClass = '';
                
                // Highlight problematic lines
                if (line.includes('y <= sum')) {
                    cssClass = 'highlight-removed';
                }
                
                html += `<div class="code-line ${cssClass}"><span class="code-line-number">${lineNum}</span>${escapeHtml(line)}</div>`;
            });
            
            html += '</div></div>';
            
            // Optimized code panel
            html += '<div class="code-panel">';
            html += '<div class="code-panel-header optimized">✅ Optimized Code (Timing Fixed)</div>';
            html += '<div class="code-panel-content">';
            
            if (optimizedCode) {
                const optimizedLines = optimizedCode.split('\n');
                optimizedLines.forEach((line, index) => {
                    const lineNum = (index + 1).toString().padStart(2, ' ');
                    let cssClass = '';
                    
                    // Highlight new/changed lines
                    if (line.includes('y_pipe1') || line.includes('y <= y_pipe1')) {
                        cssClass = 'highlight-added';
                    }
                    
                    html += `<div class="code-line ${cssClass}"><span class="code-line-number">${lineNum}</span>${escapeHtml(line)}</div>`;
                });
            } else {
                html += '<div class="code-line">No optimized code available</div>';
            }
            
            html += '</div></div>';
            html += '</div>';
            
            return html;
        }
        
        function createDiffView(diffText) {
            if (!diffText) return '';
            
            const lines = diffText.split('\n');
            let html = '<div class="code-diff">';
            
            // Add header
            html += '<div class="diff-header">📝 File Differences (+ Added, - Removed)</div>';
            
            let lineNumber = 1;
            
            lines.forEach(line => {
                if (line.startsWith('---') || line.startsWith('+++')) {
                    // File headers - skip or show as info
                    return;
                }
                
                if (line.startsWith('@@')) {
                    // Context header
                    html += `<div class="diff-line diff-header">${escapeHtml(line)}</div>`;
                    return;
                }
                
                let cssClass = 'diff-line-unchanged';
                let prefix = '';
                let displayLine = line;
                
                if (line.startsWith('+')) {
                    cssClass = 'diff-line-added';
                    prefix = '+ ';
                    displayLine = line.substring(1);
                } else if (line.startsWith('-')) {
                    cssClass = 'diff-line-removed'; 
                    prefix = '- ';
                    displayLine = line.substring(1);
                } else if (line.startsWith(' ')) {
                    cssClass = 'diff-line-unchanged';
                    prefix = '  ';
                    displayLine = line.substring(1);
                }
                
                html += `<div class="diff-line ${cssClass}">`;
                html += `<span class="diff-line-number">${lineNumber.toString().padStart(3, ' ')}</span>`;
                html += `${prefix}${escapeHtml(displayLine)}`;
                html += '</div>';
                
                if (!line.startsWith('@@')) lineNumber++;
            });
            
            html += '</div>';
            return html;
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Chat functionality
        function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Add user message
            addMessage(message, 'user');
            input.value = '';
            
            // Send to backend
            fetch('/api/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    message: message
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    addMessage(data.response, 'ai');
                } else {
                    addMessage('Sorry, I encountered an error. Please try again.', 'ai');
                }
            })
            .catch(error => {
                console.error('Chat error:', error);
                addMessage('Sorry, I encountered an error. Please try again.', 'ai');
            });
        }

        function addMessage(text, sender) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            messageDiv.innerHTML = `<strong>${sender === 'user' ? 'You' : 'AI Assistant'}:</strong> ${text}`;
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Download JSON functionality
        function downloadJSON() {
            // Create a temporary link and trigger download
            const link = document.createElement('a');
            link.href = '/api/download/json';
            link.download = 'timing_analysis.json';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            // Show a brief notification
            addMessage('JSON file download started. The timing analysis data created by the log parser has been downloaded.', 'ai');
        }
        
        // Download Verilog functionality
        function downloadVerilog() {
            // Create a temporary link and trigger download
            const link = document.createElement('a');
            link.href = '/api/download/verilog';
            link.download = 'optimized_timing_top.sv';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            // Show a brief notification
            addMessage('Verilog file download started. The optimized timing code has been downloaded as top.sv', 'ai');
        }
    </script>
</body>
</html>